@model IEnumerable<HRMS.Models.Notification>

@{
    ViewData["Title"] = "Notifications";
    ViewData["FullWidth"] = true;
    var unreadCount = ViewBag.UnreadCount ?? 0;
    var currentFilter = ViewBag.CurrentFilter ?? "all";
}

<link rel="stylesheet" href="~/css/notifications.css" />

<div class="premium-card card-full-width notifications-page">
    <!-- Header Section -->
    <div class="notifications-header">
        <div class="notifications-header-left">
            <div class="notifications-header-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
            </div>
            <div class="notifications-header-title">
                <h1>@ViewBag.FilterTitle</h1>
                @if (unreadCount > 0)
                {
                    <div class="notifications-header-badge unread">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <span>@unreadCount Unread Notification@(unreadCount == 1 ? "" : "s")</span>
                    </div>
                }
                else
                {
                    <div class="notifications-header-badge all-read">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span>All Caught Up!</span>
                    </div>
                }
            </div>
        </div>
        
        <div class="notifications-filters">
            <a asp-action="Index" asp-route-filter="all" 
               class="notification-filter-btn @(currentFilter == "all" ? "active" : "")">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                <span>All</span>
            </a>
            <a asp-action="Index" asp-route-filter="unread" 
               class="notification-filter-btn @(currentFilter == "unread" ? "active" : "")">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                <span>Unread @(unreadCount > 0 ? $"({unreadCount})" : "")</span>
            </a>
            @if (unreadCount > 0)
            {
                <button type="button" class="mark-all-read-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span>Mark All Read</span>
                </button>
            }
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert" style="margin-bottom: 2rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            @TempData["SuccessMessage"]
        </div>
    }

    <!-- Notifications List -->
    @if (!Model.Any())
    {
        <!-- Empty State -->
        <div class="notifications-empty-state">
            <svg class="notifications-empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <h3>No Notifications</h3>
            <p>
                @if (currentFilter == "unread")
                {
                    <text>You don't have any unread notifications. Great job staying on top of things!</text>
                }
                else
                {
                    <text>You don't have any notifications yet. We'll notify you when there's something important.</text>
                }
            </p>
            @if (currentFilter == "unread")
            {
                <a asp-action="Index" asp-route-filter="all" class="notification-filter-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <line x1="3" y1="6" x2="3.01" y2="6"></line>
                        <line x1="3" y1="12" x2="3.01" y2="12"></line>
                        <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                    <span>View All Notifications</span>
                </a>
            }
        </div>
    }
    else
    {
        <div class="notifications-container">
            @{
                var index = 0;
            }
            @foreach (var notification in Model)
            {
                var employeeNotification = notification.Employee_Notification?.FirstOrDefault();
                var isUnread = employeeNotification?.delivery_status != "Read";
                var urgencyClass = notification.urgency switch
                {
                    "High" => "urgent",
                    "Medium" => "medium",
                    _ => ""
                };
                var iconType = notification.notification_type?.ToLower() switch
                {
                    "contract" => "contract",
                    "leave" => "leave",
                    "attendance" => "attendance",
                    "salary" => "salary",
                    _ => ""
                };

                <div class="notification-card @(isUnread ? "unread" : "") @urgencyClass" 
                     style="animation-delay: @(index * 0.05)s;">
                    <div class="notification-content">
                        <!-- Notification Icon -->
                        <div class="notification-icon-wrapper">
                            <div class="notification-icon @iconType @(isUnread ? "unread-pulse" : "read")">
                                @if (notification.notification_type == "Contract")
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                    </svg>
                                }
                                else if (notification.notification_type == "Leave")
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                }
                                else if (notification.notification_type == "Attendance")
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                }
                                else if (notification.notification_type == "Salary")
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                    </svg>
                                }
                                else
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="16" x2="12" y2="12"></line>
                                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                    </svg>
                                }
                            </div>
                        </div>

                        <!-- Notification Body -->
                        <div class="notification-body">
                            <div class="notification-header-row">
                                <div class="notification-title">
                                    @if (isUnread)
                                    {
                                        <span class="new-badge">New</span>
                                    }
                                    <h3>@notification.notification_type Notification</h3>
                                </div>
                                
                                @if (notification.urgency == "High")
                                {
                                    <div class="notification-urgency-badge urgent">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        <span>Urgent</span>
                                    </div>
                                }
                                else if (notification.urgency == "Medium")
                                {
                                    <div class="notification-urgency-badge medium">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                            <line x1="12" y1="9" x2="12" y2="13"></line>
                                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                        </svg>
                                        <span>Medium</span>
                                    </div>
                                }
                            </div>

                            <div class="notification-meta">
                                <div class="notification-meta-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <span>@(notification.timestamp.HasValue ? notification.timestamp.Value.ToLocalTime().ToString("MMM dd, yyyy h:mm tt") : "N/A")</span>
                                </div>
                                <div class="notification-meta-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                                    </svg>
                                    <span>@notification.notification_type</span>
                                </div>
                            </div>

                            <p class="notification-message">@notification.message_content</p>

                            <div class="notification-actions">
                                <a asp-action="Details" asp-route-id="@notification.notification_id" 
                                   class="notification-action-btn view-details">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    <span>View Details</span>
                                </a>
                                
                                @if (isUnread)
                                {
                                    <button type="button" class="notification-action-btn mark-read mark-read-btn" 
                                            data-notification-id="@notification.notification_id">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        <span>Mark as Read</span>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                index++;
            }
        </div>
    }
</div>


@section Scripts {
    <!-- Hidden form for AntiForgeryToken -->
    @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "anti-forgery-form", style = "display: none;" }))
    {
        @Html.AntiForgeryToken()
    }
    
    <script>
        (function() {
            // Get AntiForgeryToken
            function getAntiForgeryToken() {
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                if (tokenInput) {
                    return tokenInput.value;
                }
                return null;
            }

            // Mark notification as read via AJAX
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const notificationId = this.dataset.notificationId;
                    const card = this.closest('.notification-card');
                    const button = this;
                    
                    // Disable button and show loading state
                    button.disabled = true;
                    button.classList.add('btn-loading');
                    
                    try {
                        const token = getAntiForgeryToken();
                        if (!token) {
                            throw new Error('AntiForgeryToken not found');
                        }
                        
                        const formData = new URLSearchParams();
                        formData.append('id', notificationId);
                        formData.append('__RequestVerificationToken', token);
                        
                        const response = await fetch('@Url.Action("MarkAsRead", "Notification")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData.toString()
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Visual feedback with animation
                            card.style.transition = 'all 0.3s ease';
                            card.classList.remove('unread');
                            
                            const iconDiv = card.querySelector('.notification-icon');
                            if (iconDiv) {
                                iconDiv.classList.remove('unread-pulse');
                                iconDiv.classList.add('read');
                            }
                            
                            // Remove "New" badge
                            const newBadge = card.querySelector('.new-badge');
                            if (newBadge) {
                                newBadge.style.transition = 'opacity 0.3s ease';
                                newBadge.style.opacity = '0';
                                setTimeout(() => newBadge.remove(), 300);
                            }
                            
                            // Fade out and remove button
                            button.style.transition = 'opacity 0.3s ease';
                            button.style.opacity = '0';
                            setTimeout(() => button.remove(), 300);
                            
                            // Update unread count badge
                            updateUnreadCount(-1);
                            
                            // Show success toast
                            if (window.HRMS && window.HRMS.Toast) {
                                window.HRMS.Toast.success('Notification marked as read');
                            }
                        } else {
                            throw new Error('Server returned success: false');
                        }
                    } catch (error) {
                        console.error('Error marking notification as read:', error);
                        button.disabled = false;
                        button.classList.remove('btn-loading');
                        
                        if (window.HRMS && window.HRMS.Toast) {
                            window.HRMS.Toast.error('Failed to mark notification as read');
                        }
                    }
                });
            });

            // Mark all as read functionality
            const markAllReadBtn = document.querySelector('.mark-all-read-btn');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    if (!confirm('Are you sure you want to mark all notifications as read?')) {
                        return;
                    }
                    
                    const button = this;
                    button.disabled = true;
                    button.classList.add('btn-loading');
                    
                    try {
                        const token = getAntiForgeryToken();
                        if (!token) {
                            throw new Error('AntiForgeryToken not found');
                        }
                        
                        const formData = new URLSearchParams();
                        formData.append('__RequestVerificationToken', token);
                        
                        const response = await fetch('@Url.Action("MarkAllAsRead", "Notification")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData.toString()
                        });
                        
                        if (response.ok) {
                            // Reload page to reflect changes
                            window.location.reload();
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('Error marking all as read:', error);
                        button.disabled = false;
                        button.classList.remove('btn-loading');
                        
                        if (window.HRMS && window.HRMS.Toast) {
                            window.HRMS.Toast.error('Failed to mark all notifications as read');
                        }
                    }
                });
            }

            // Helper function to update unread count
            function updateUnreadCount(delta) {
                const badge = document.querySelector('.notifications-header-badge');
                let newCount = 0;
                
                if (badge) {
                    const currentText = badge.textContent.trim();
                    const match = currentText.match(/(\d+)/);
                    if (match) {
                        const currentCount = parseInt(match[1]);
                        newCount = Math.max(0, currentCount + delta);
                    } else {
                        // If badge shows "All Caught Up", count is 0
                        newCount = delta > 0 ? delta : 0;
                    }
                    
                    if (newCount > 0) {
                        if (badge.classList.contains('all-read')) {
                            badge.className = 'notifications-header-badge unread';
                        }
                        badge.innerHTML = `
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <span>${newCount} Unread Notification${newCount === 1 ? '' : 's'}</span>
                        `;
                    } else {
                        badge.className = 'notifications-header-badge all-read';
                        badge.innerHTML = `
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            <span>All Caught Up!</span>
                        `;
                        
                        // Hide "Mark All Read" button
                        const markAllBtn = document.querySelector('.mark-all-read-btn');
                        if (markAllBtn) {
                            markAllBtn.style.transition = 'opacity 0.3s ease';
                            markAllBtn.style.opacity = '0';
                            setTimeout(() => markAllBtn.remove(), 300);
                        }
                    }
                }
                
                // Update "Unread" filter button
                const unreadFilterBtn = document.querySelector('a[href*="filter=unread"]');
                if (unreadFilterBtn) {
                    const span = unreadFilterBtn.querySelector('span');
                    if (span) {
                        if (newCount > 0) {
                            span.textContent = `Unread (${newCount})`;
                        } else {
                            span.textContent = 'Unread';
                        }
                    }
                }
                
                // Update navbar notification count if available
                if (window.HRMS && window.HRMS.Notifications) {
                    window.HRMS.Notifications.fetchUnreadCount();
                }
            }

            // Auto-refresh unread count every 30 seconds
            setInterval(async () => {
                try {
                    const response = await fetch('@Url.Action("GetUnreadCount", "Notification")');
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Update navbar badge if it exists
                        const navBadge = document.querySelector('.notification-badge, #navbar-notification-badge');
                        if (navBadge) {
                            if (data.count > 0) {
                                navBadge.textContent = data.count;
                                navBadge.classList.remove('d-none');
                            } else {
                                navBadge.classList.add('d-none');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching unread count:', error);
                }
            }, 30000);
        })();
    </script>
}

