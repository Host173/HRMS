@{
    ViewData["Title"] = "Analytics & Reports";
    ViewData["FullWidth"] = true;
}

<link rel="stylesheet" href="~/css/analytics.css" />

<div class="premium-card card-full-width analytics-container" style="margin-bottom: 2rem;">
    <div class="analytics-header">
        <div class="analytics-header-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"></path>
                <path d="M18 7c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z"></path>
                <path d="M18 14c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z"></path>
                <path d="M9 10c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z"></path>
            </svg>
        </div>
        <h1>Analytics & Reports</h1>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-error" role="alert" style="margin-bottom: 2rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            @TempData["ErrorMessage"]
        </div>
    }

    <!-- Department Statistics -->
    <section class="analytics-section">
        <div class="analytics-section-header">
            <div class="analytics-section-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <h2>Department Statistics</h2>
        </div>
        <p class="analytics-section-description">
            Overview of employee distribution across all departments. Search to quickly find specific departments.
        </p>
        
        <div style="margin-bottom: 1.5rem;">
            <div class="analytics-search-box">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" id="deptSearch" placeholder="Search departments..." onkeyup="filterDepartmentTable()" />
            </div>
        </div>

        @if (ViewBag.DepartmentStats != null && ((List<HRMS.Models.DepartmentStatisticsViewModel>)ViewBag.DepartmentStats).Any())
        {
            var stats = (List<HRMS.Models.DepartmentStatisticsViewModel>)ViewBag.DepartmentStats;
            var totalEmployees = stats.Sum(s => s.TotalEmployees);
            var totalActive = stats.Sum(s => s.ActiveEmployees);
            var totalInactive = stats.Sum(s => s.InactiveEmployees);
            
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-card-label">Total Departments</div>
                    <div class="stat-card-value primary">@stats.Count</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Total Employees</div>
                    <div class="stat-card-value">@totalEmployees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Active Employees</div>
                    <div class="stat-card-value success">@totalActive</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Inactive Employees</div>
                    <div class="stat-card-value danger">@totalInactive</div>
                </div>
            </div>

            <div class="analytics-table-container">
                <table id="deptTable" class="analytics-table">
                    <thead>
                        <tr>
                            <th>Department</th>
                            <th class="text-center">Total Employees</th>
                            <th class="text-center">Active</th>
                            <th class="text-center">Inactive</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var stat in stats)
                        {
                            <tr>
                                <td style="font-weight: 600;">@stat.DepartmentName</td>
                                <td class="text-center">@stat.TotalEmployees</td>
                                <td class="text-center text-success">@stat.ActiveEmployees</td>
                                <td class="text-center text-danger">@stat.InactiveEmployees</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="analytics-empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <p>No department statistics available.</p>
            </div>
        }
    </section>

    <!-- Compliance Reports -->
    <section class="analytics-section">
        <div class="analytics-section-header">
            <div class="analytics-section-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <h2>Compliance Reports</h2>
        </div>
        <p class="analytics-section-description">
            Generate comprehensive compliance reports to analyze contract and attendance compliance across the organization. Use search and filters to narrow down results.
        </p>
        
        <!-- Search and Filter Form -->
        <div class="report-form-card">
            <div class="report-form-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <h3>Search & Filter Options</h3>
            </div>
            <form id="complianceSearchForm" method="post" class="report-form-grid">
                @Html.AntiForgeryToken()
                <div class="report-form-group">
                    <label for="complianceSearchTerm" class="report-form-label">Search (Name, Email)</label>
                    <input type="text" id="complianceSearchTerm" name="searchTerm" 
                           value="@(ViewBag.SearchTerm ?? "")"
                           placeholder="Search by name or email..."
                           class="report-form-input" />
                </div>
                <div class="report-form-group">
                    <label for="complianceDepartmentId" class="report-form-label">Filter by Department</label>
                    <select id="complianceDepartmentId" name="departmentId" class="report-form-select">
                        <option value="">All Departments</option>
                        @if (ViewBag.Departments != null)
                        {
                            @foreach (var dept in (List<HRMS.Models.Department>)ViewBag.Departments)
                            {
                                <option value="@dept.department_id" selected="@(ViewBag.SelectedDepartmentId != null && ViewBag.SelectedDepartmentId.ToString() == dept.department_id.ToString())">
                                    @dept.department_name
                                </option>
                            }
                        }
                    </select>
                </div>
                <div class="report-form-group">
                    <button type="submit" formaction="@Url.Action("GenerateComplianceReport", "Component5", new { reportType = "contract" })" 
                            class="report-form-button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Contract Report
                    </button>
                </div>
                <div class="report-form-group">
                    <button type="submit" formaction="@Url.Action("GenerateComplianceReport", "Component5", new { reportType = "attendance" })" 
                            class="report-form-button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Attendance Report
                    </button>
                </div>
            </form>
        </div>

        @if (ViewBag.ComplianceReport != null)
        {
            var report = (HRMS.Models.ComplianceReportViewModel)ViewBag.ComplianceReport;
            <div class="report-results-card">
                <div class="report-results-header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    <h3>@report.ReportType</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-label">Total Records</div>
                        <div class="stat-card-value">@report.TotalRecords</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-label">Compliant</div>
                        <div class="stat-card-value success">@report.CompliantRecords</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-label">Non-Compliant</div>
                        <div class="stat-card-value danger">@report.NonCompliantRecords</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-label">Compliance Rate</div>
                        <div class="stat-card-value primary">@report.CompliancePercentage.ToString("F1")%</div>
                    </div>
                </div>
            </div>
        }
    </section>

    <!-- Diversity Reports -->
    <section class="analytics-section">
        <div class="analytics-section-header">
            <div class="analytics-section-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <h2>Diversity Reports</h2>
        </div>
        <p class="analytics-section-description">
            Generate comprehensive diversity reports to analyze employee distribution across departments, positions, and demographics. Use search and filters to narrow down results.
        </p>
        
        <!-- Search and Filter Form -->
        <div class="report-form-card">
            <div class="report-form-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <h3>Search & Filter Options</h3>
            </div>
            <form asp-controller="Component5" asp-action="GenerateDiversityReport" method="post" class="report-form-grid">
                @Html.AntiForgeryToken()
                <div class="report-form-group">
                    <label for="diversitySearchTerm" class="report-form-label">Search (Name, Email, Position)</label>
                    <input type="text" id="diversitySearchTerm" name="searchTerm" 
                           value="@(ViewBag.SearchTerm ?? "")"
                           placeholder="Search by name, email, or position..."
                           class="report-form-input" />
                </div>
                <div class="report-form-group">
                    <label for="diversityDepartmentId" class="report-form-label">Filter by Department</label>
                    <select id="diversityDepartmentId" name="departmentId" class="report-form-select">
                        <option value="">All Departments</option>
                        @if (ViewBag.Departments != null)
                        {
                            @foreach (var dept in (List<HRMS.Models.Department>)ViewBag.Departments)
                            {
                                <option value="@dept.department_id" selected="@(ViewBag.SelectedDepartmentId != null && ViewBag.SelectedDepartmentId.ToString() == dept.department_id.ToString())">
                                    @dept.department_name
                                </option>
                            }
                        }
                    </select>
                </div>
                <div class="report-form-group">
                    <button type="submit" class="report-form-button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        Generate Report
                    </button>
                </div>
            </form>
        </div>

        @if (ViewBag.DiversityReport != null)
        {
            var report = (HRMS.Models.DiversityReportViewModel)ViewBag.DiversityReport;
            <div class="report-results-card">
                <div class="report-results-header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h3>Diversity Statistics</h3>
                </div>
                
                <div class="stat-card" style="margin-bottom: 2rem; max-width: 300px;">
                    <div class="stat-card-label">Total Employees</div>
                    <div class="stat-card-value primary">@report.TotalEmployees</div>
                </div>

                @if (report.DepartmentDistribution.Any())
                {
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--color-text-primary); font-size: 1.125rem; font-weight: 600;">Department Distribution</h4>
                        <div class="distribution-grid">
                            @foreach (var dept in report.DepartmentDistribution)
                            {
                                <div class="distribution-card">
                                    <div class="distribution-card-label">@dept.Key</div>
                                    <div class="distribution-card-value">@dept.Value</div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (report.PositionDistribution.Any())
                {
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--color-text-primary); font-size: 1.125rem; font-weight: 600;">Position Distribution</h4>
                        <div class="distribution-grid">
                            @foreach (var pos in report.PositionDistribution)
                            {
                                <div class="distribution-card">
                                    <div class="distribution-card-label">@pos.Key</div>
                                    <div class="distribution-card-value">@pos.Value</div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (report.DepartmentStatistics.Any())
                {
                    <div>
                        <h4 style="margin-bottom: 1rem; color: var(--color-text-primary); font-size: 1.125rem; font-weight: 600;">Department-Wise Employee Statistics</h4>
                        <div class="analytics-table-container">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Department</th>
                                        <th class="text-center">Total Employees</th>
                                        <th class="text-center">Active</th>
                                        <th class="text-center">Inactive</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var deptStat in report.DepartmentStatistics)
                                    {
                                        <tr>
                                            <td style="font-weight: 600;">@deptStat.DepartmentName</td>
                                            <td class="text-center">@deptStat.TotalEmployees</td>
                                            <td class="text-center text-success">@deptStat.ActiveEmployees</td>
                                            <td class="text-center text-danger">@deptStat.InactiveEmployees</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
        }
    </section>
</div>

<script>
    function filterDepartmentTable() {
        const input = document.getElementById('deptSearch');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('deptTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            const td = tr[i].getElementsByTagName('td')[0];
            if (td) {
                const txtValue = td.textContent || td.innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }
    }
</script>
