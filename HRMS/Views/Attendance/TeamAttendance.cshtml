@model List<HRMS.Models.Attendance>
@{
    ViewData["Title"] = "Team Attendance Records";
    var teamMembers = ViewBag.TeamMembers as List<HRMS.Models.Employee> ?? new List<HRMS.Models.Employee>();
    var days = ViewBag.Days as int? ?? 90;
    var totalRecords = ViewBag.TotalRecords as int? ?? 0;
    var totalTeamSize = ViewBag.TotalTeamSize as int? ?? 0;
}

<div style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h1 style="margin: 0; font-size: 2rem; font-weight: 700;">Team Attendance Records</h1>
            <p style="margin: 0.5rem 0 0; color: var(--color-text-secondary);">
                Showing @totalRecords records for @totalTeamSize team member(s) (Last @days days)
            </p>
        </div>
        <a asp-action="Index" class="btn-premium btn-secondary" style="padding: 0.75rem 1.5rem;">
            ‚Üê Back to Attendance
        </a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid var(--color-success); color: var(--color-success); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--color-danger); color: var(--color-danger); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
            @TempData["ErrorMessage"]
        </div>
    }

    @if (TempData["InfoMessage"] != null)
    {
        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid var(--color-primary); color: var(--color-primary); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
            @TempData["InfoMessage"]
        </div>
    }

    <!-- Filter Options -->
    <div style="background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 1.5rem; margin-bottom: 1.5rem;">
        <form method="get" asp-action="TeamAttendance" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--color-text-primary);">Period</label>
                <select name="days" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg); color: var(--color-text-primary); font-size: 1rem;">
                    <option value="7" selected="@(days == 7)">Last 7 days</option>
                    <option value="30" selected="@(days == 30)">Last 30 days</option>
                    <option value="60" selected="@(days == 60)">Last 60 days</option>
                    <option value="90" selected="@(days == 90)">Last 90 days</option>
                    <option value="180" selected="@(days == 180)">Last 180 days</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn-premium btn-primary" style="padding: 0.75rem 1.5rem; white-space: nowrap;">
                    Apply Filter
                </button>
            </div>
        </form>
    </div>
</div>

@if (Model == null || !Model.Any())
{
    <div style="background: var(--color-surface); padding: 3rem; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-md);">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 1rem; opacity: 0.5;">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <h3 style="color: var(--color-text-secondary); margin-bottom: 0.5rem;">No Attendance Records Found</h3>
        <p style="color: var(--color-text-secondary);">No attendance records found for your team in the selected period.</p>
    </div>
}
else
{
    <div style="background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); overflow: hidden;">
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--color-bg-light); border-bottom: 2px solid var(--color-border);">
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-text-primary);">Employee</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-text-primary);">Date</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-text-primary);">Clock In</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-text-primary);">Clock Out</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-text-primary);">Duration</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-text-primary);">Status</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-text-primary);">Method</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var record in Model)
                    {
                        <tr style="border-bottom: 1px solid var(--color-border); transition: background var(--transition-fast);" 
                            onmouseover="this.style.background='var(--color-bg-light)'" 
                            onmouseout="this.style.background='transparent'">
                            <td style="padding: 1rem; color: var(--color-text-primary);">
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 36px; height: 36px; background: var(--color-primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-right: 0.75rem; font-size: 0.875rem;">
                                        @((record.employee?.full_name?.Substring(0, 1).ToUpper() ?? record.employee?.email?.Substring(0, 1).ToUpper() ?? "?")[0])
                                    </div>
                                    <div>
                                        <div style="font-weight: 500;">@(record.employee?.full_name ?? record.employee?.email ?? "Unknown")</div>
                                        @if (!string.IsNullOrEmpty(record.employee?.email) && record.employee?.email != record.employee?.full_name)
                                        {
                                            <div style="font-size: 0.875rem; color: var(--color-text-secondary);">@record.employee.email</div>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 1rem; color: var(--color-text-primary);">
                                @(record.entry_time?.ToString("MMM dd, yyyy") ?? "N/A")
                            </td>
                            <td style="padding: 1rem; color: var(--color-text-primary);">
                                @if (record.entry_time.HasValue)
                                {
                                    <div style="font-weight: 500;">@record.entry_time.Value.ToString("hh:mm tt")</div>
                                    @if (!string.IsNullOrEmpty(record.login_method))
                                    {
                                        <div style="font-size: 0.875rem; color: var(--color-text-secondary);">@record.login_method</div>
                                    }
                                }
                                else
                                {
                                    <span style="color: var(--color-text-secondary);">-</span>
                                }
                            </td>
                            <td style="padding: 1rem; color: var(--color-text-primary);">
                                @if (record.exit_time.HasValue)
                                {
                                    <div style="font-weight: 500;">@record.exit_time.Value.ToString("hh:mm tt")</div>
                                    @if (!string.IsNullOrEmpty(record.logout_method))
                                    {
                                        <div style="font-size: 0.875rem; color: var(--color-text-secondary);">@record.logout_method</div>
                                    }
                                }
                                else
                                {
                                    <span style="color: var(--color-danger); font-weight: 500;">Active</span>
                                }
                            </td>
                            <td style="padding: 1rem; color: var(--color-text-primary);">
                                @if (record.duration.HasValue)
                                {
                                    <span style="font-weight: 500;">@record.duration.Value.ToString("F2") hrs</span>
                                }
                                else if (!record.exit_time.HasValue)
                                {
                                    <span style="color: var(--color-text-secondary);">-</span>
                                }
                                else
                                {
                                    <span style="color: var(--color-text-secondary);">N/A</span>
                                }
                            </td>
                            <td style="padding: 1rem;">
                                @if (record.exception_id.HasValue)
                                {
                                    <span style="background: rgba(239, 68, 68, 0.1); color: var(--color-danger); padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 500;">
                                        Late
                                    </span>
                                }
                                else if (!record.exit_time.HasValue)
                                {
                                    <span style="background: rgba(34, 197, 94, 0.1); color: var(--color-success); padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 500;">
                                        Active
                                    </span>
                                }
                                else
                                {
                                    <span style="background: rgba(59, 130, 246, 0.1); color: var(--color-primary); padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 500;">
                                        Complete
                                    </span>
                                }
                            </td>
                            <td style="padding: 1rem; color: var(--color-text-primary);">
                                @if (!string.IsNullOrEmpty(record.login_method) && !string.IsNullOrEmpty(record.logout_method))
                                {
                                    <span style="font-size: 0.875rem;">@record.login_method / @record.logout_method</span>
                                }
                                else if (!string.IsNullOrEmpty(record.login_method))
                                {
                                    <span style="font-size: 0.875rem;">@record.login_method</span>
                                }
                                else if (!string.IsNullOrEmpty(record.logout_method))
                                {
                                    <span style="font-size: 0.875rem;">@record.logout_method</span>
                                }
                                else
                                {
                                    <span style="color: var(--color-text-secondary); font-size: 0.875rem;">-</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @if (Model.Count > 100)
    {
        <div style="margin-top: 1rem; text-align: center; color: var(--color-text-secondary); font-size: 0.875rem;">
            Showing all @Model.Count records. Use the filter to narrow down results.
        </div>
    }
}

@section Scripts {
    <script>
        // Auto-refresh every 60 seconds if there are active attendance records
        @if (Model != null && Model.Any(r => !r.exit_time.HasValue))
        {
            <text>
            setTimeout(function() {
                location.reload();
            }, 60000);
            </text>
        }
    </script>
}

