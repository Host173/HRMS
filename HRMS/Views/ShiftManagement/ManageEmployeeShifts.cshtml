@{
    ViewData["Title"] = "Manage Employee Shifts";
    var employees = ViewBag.Employees as List<HRMS.Models.Employee> ?? new List<HRMS.Models.Employee>();
    var shifts = ViewBag.Shifts as List<HRMS.Models.ShiftSchedule> ?? new List<HRMS.Models.ShiftSchedule>();
    var selectedEmployee = ViewBag.SelectedEmployee as HRMS.Models.Employee;
    var assignments = ViewBag.Assignments as List<HRMS.Models.ShiftAssignment> ?? new List<HRMS.Models.ShiftAssignment>();
}

<div style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="margin: 0; font-size: 2rem; font-weight: 700;">Manage Employee Shifts</h1>
        <a asp-action="Index" class="btn-premium btn-secondary">‚Üê Back to Shift Management</a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid var(--color-success); color: var(--color-success); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--color-danger); color: var(--color-danger); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
            @TempData["ErrorMessage"]
        </div>
    }

    <!-- Employee Selection -->
    <div style="background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 2rem; margin-bottom: 2rem;">
        <form method="get" asp-action="ManageEmployeeShifts" style="display: flex; gap: 1rem; align-items: flex-end;">
            <div style="flex: 1;">
                <label for="employeeId" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select Employee</label>
                <select id="employeeId" name="employeeId" onchange="this.form.submit()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;">
                    <option value="">Choose an employee...</option>
                    @foreach (var employee in employees)
                    {
                        <option value="@employee.employee_id" selected="@(selectedEmployee?.employee_id == employee.employee_id)">@(employee.full_name ?? employee.email)</option>
                    }
                </select>
            </div>
        </form>
    </div>

    @if (selectedEmployee != null)
    {
        <!-- Add New Assignment Form -->
        <div style="background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 2rem; margin-bottom: 2rem;">
            <h2 style="margin: 0 0 1.5rem; font-size: 1.25rem; font-weight: 600;">Add New Shift Assignment</h2>
            <form asp-action="AssignEmployeeShift" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="employeeId" value="@selectedEmployee.employee_id" />

                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label for="shiftId" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Shift *</label>
                        <select id="shiftId" name="shiftId" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;">
                            <option value="">Choose a shift...</option>
                            @foreach (var shift in shifts)
                            {
                                <option value="@shift.shift_id">@shift.name (@shift.start_time?.ToString("hh:mm tt") - @shift.end_time?.ToString("hh:mm tt"))</option>
                            }
                        </select>
                    </div>
                    <div>
                        <label for="startDate" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Start Date</label>
                        <input type="date" id="startDate" name="startDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;" />
                    </div>
                    <div>
                        <label for="endDate" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">End Date</label>
                        <input type="date" id="endDate" name="endDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;" />
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="notes" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes</label>
                    <textarea id="notes" name="notes" rows="2" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;"></textarea>
                </div>
                <button type="submit" class="btn-premium btn-primary" style="padding: 0.75rem 1.5rem;">Add Assignment</button>
            </form>
        </div>

        <!-- Existing Assignments -->
        <div style="background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 2rem;">
            <h2 style="margin: 0 0 1.5rem; font-size: 1.25rem; font-weight: 600;">Current Assignments for @(selectedEmployee.full_name ?? selectedEmployee.email)</h2>

            @if (assignments.Any())
            {
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--color-bg-light); border-bottom: 2px solid var(--color-border);">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Shift</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Start Date</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">End Date</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Notes</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var assignment in assignments)
                            {
                                <tr style="border-bottom: 1px solid var(--color-border);">
                                    <td style="padding: 0.75rem;">@assignment.shift.name</td>
                                    <td style="padding: 0.75rem;">@(assignment.start_date?.ToString("MMM dd, yyyy") ?? "N/A")</td>
                                    <td style="padding: 0.75rem;">@(assignment.end_date?.ToString("MMM dd, yyyy") ?? "Ongoing")</td>
                                    <td style="padding: 0.75rem;">
                                        <span style="background: rgba(34, 197, 94, 0.1); color: var(--color-success); padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem;">
                                            @(assignment.status ?? "Active")
                                        </span>
                                    </td>
                                    <td style="padding: 0.75rem;">@(assignment.notes ?? "-")</td>
                                    <td style="padding: 0.75rem;">
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="editAssignment(@assignment.assignment_id, @assignment.shift_id, '@assignment.start_date?.ToString("yyyy-MM-dd")', '@assignment.end_date?.ToString("yyyy-MM-dd")', '@(assignment.notes ?? "")', '@(assignment.status ?? "Active")')" class="btn-premium btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Edit</button>
                                            <form asp-action="DeleteEmployeeShift" asp-route-assignmentId="@assignment.assignment_id" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this assignment?');">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn-premium" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--color-danger); color: white;">Delete</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p style="color: var(--color-text-secondary); text-align: center; padding: 2rem;">No shift assignments found for this employee.</p>
            }
        </div>
    }
    else
    {
        <div style="background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 3rem; text-align: center;">
            <p style="color: var(--color-text-secondary);">Please select an employee to manage their shift assignments.</p>
        </div>
    }
</div>

<!-- Edit Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--color-surface); border-radius: var(--radius-lg); padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin: 0 0 1.5rem; font-size: 1.5rem; font-weight: 600;">Edit Shift Assignment</h2>
        <form id="editForm" method="post" asp-action="UpdateEmployeeShift">
            @Html.AntiForgeryToken()
            <input type="hidden" id="editAssignmentId" name="assignmentId" />
            <input type="hidden" name="employeeId" value="@selectedEmployee?.employee_id" />

            <div style="margin-bottom: 1rem;">
                <label for="editShiftId" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Shift *</label>
                <select id="editShiftId" name="shiftId" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;"></select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label for="editStartDate" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Start Date</label>
                    <input type="date" id="editStartDate" name="startDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;" />
                </div>
                <div>
                    <label for="editEndDate" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">End Date</label>
                    <input type="date" id="editEndDate" name="endDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;" />
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="editStatus" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Status</label>
                <select id="editStatus" name="status" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;">
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label for="editNotes" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes</label>
                <textarea id="editNotes" name="notes" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn-premium btn-primary" style="padding: 0.75rem 1.5rem;">Update Assignment</button>
                <button type="button" onclick="closeEditModal()" class="btn-premium btn-secondary" style="padding: 0.75rem 1.5rem;">Cancel</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        const shifts = @Html.Raw(Json.Serialize(shifts.Select(s => new { shift_id = s.shift_id, name = s.name })));
        
        function editAssignment(assignmentId, shiftId, startDate, endDate, notes, status) {
            document.getElementById('editAssignmentId').value = assignmentId;
            document.getElementById('editStartDate').value = startDate || '';
            document.getElementById('editEndDate').value = endDate || '';
            document.getElementById('editNotes').value = notes || '';
            document.getElementById('editStatus').value = status || 'Active';
            
            const shiftSelect = document.getElementById('editShiftId');
            shiftSelect.innerHTML = '';
            shifts.forEach(shift => {
                const option = document.createElement('option');
                option.value = shift.shift_id;
                option.textContent = shift.name;
                option.selected = shift.shift_id === shiftId;
                shiftSelect.appendChild(option);
            });
            
            document.getElementById('editModal').style.display = 'flex';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // Close modal on outside click
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        // Set default start date
        document.getElementById('startDate').valueAsDate = new Date();
    </script>
}

